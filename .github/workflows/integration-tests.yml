name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      model_filter:
        description: 'Model filter for tests (e.g. "qwen")'
        required: false
        default: ''
  pull_request:

jobs:
  integration-tests:
    runs-on: mac2.metal
    timeout-minutes: 60
    env:
      PROJECT_ROOT: ${{ github.workspace }}
      PYTHONPATH: src

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Environment
        uses: ./.github/actions/setup-env
        with:
          python_version: '3.12'

      - name: Ensure compatible gRPC/protobuf versions
        run: |
          uv pip install --upgrade "grpcio>=1.75.1" "protobuf>=6.31.1"

      - name: Kill processes on required ports
        run: |
          # Kill any processes on the ports we need
          for port in 8080 8081 58080 58081; do
            lsof -ti:$port | xargs kill -9 2>/dev/null || true
          done
          sleep 2

      - name: Start shard server
        run: |
          uv run dnet-shard --http-port 8081 --grpc-port 58081 > shard.log 2>&1 &

          # Wait for port to be ready
          for i in {1..30}; do
            if lsof -ti:8081 > /dev/null; then
              echo "Shard port is open."
              break
            fi
            echo "Waiting for shard port... ($i/30)"
            sleep 1
          done

          SHARD_PID=$(lsof -ti:8081) || true
          if [ -z "$SHARD_PID" ]; then
            echo "Shard failed to start or bind port. Logs:"
            cat shard.log
            exit 1
          fi

          echo "SHARD_PID=$SHARD_PID" >> $GITHUB_ENV
          echo "Shard started with PID $SHARD_PID"

      - name: Start API server
        run: |
          uv run dnet-api --http-port 8080 --grpc-port 58080 > api.log 2>&1 &

          # Wait for port to be ready
          for i in {1..30}; do
            if lsof -ti:8080 > /dev/null; then
              echo "API port is open."
              break
            fi
            echo "Waiting for API port... ($i/30)"
            sleep 1
          done

          API_PID=$(lsof -ti:8080) || true
          if [ -z "$API_PID" ]; then
            echo "API failed to start or bind port. Logs:"
            cat api.log
            exit 1
          fi

          API_PID=$(lsof -ti:8080)
          echo "API_PID=$API_PID" >> $GITHUB_ENV
          echo "API started with PID $API_PID"

      - name: Wait for servers to be healthy
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8080/health | grep -q "ok"; then
              echo "API server is healthy"
              exit 0
            fi
            echo "Waiting for API server... ($i/30)"
            sleep 2
          done
          echo "API server failed to become healthy"
          exit 1

      - name: Run integration tests
        run: |
          if [ -n "${{ github.event.inputs.model_filter }}" ]; then
            uv run pytest tests/integration/test_model_catalog.py -v -x -k "${{ github.event.inputs.model_filter }}" --tb=short
          else
            uv run pytest tests/integration/test_model_catalog.py -v -x --tb=short
          fi

      - name: Cleanup servers
        if: always()
        run: |
          kill $API_PID 2>/dev/null || true
          kill $SHARD_PID 2>/dev/null || true
